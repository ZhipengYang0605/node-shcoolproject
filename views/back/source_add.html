<!-- 继承base.html的基础样式 -->
{% extends "back/base.html" %}

<!-- 要新增的样式 -->
{% block style %}
{% endblock %}

<!-- 主要内容 -->
{% block body %}
<div class="container-fluid">
    <div class="body advert">
        <!-- 面包屑 -->
        <ol class="breadcrumb">
            <li><a href="/back/source_list">资源文章管理</a></li>
            <li class="active">添加文章</li>
        </ol>
        <div class="advert-add">
            <form action="/back/source/api/add" class="form-horizontal" method="POST" enctype="multipart/form-data">
                <div class="form-group">
                    <label for="" class="col-md-3 control-label">标题</label>
                    <div class="col-md-5">
                        <input name="title" type="text" class="form-control input-sm" placeholder="填写文章标题" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-md-3 control-label">作者</label>
                    <div class="col-md-5">
                        <input name="author" type="text" class="form-control input-sm" placeholder="请填写文章作者" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-md-3 control-label">缩略图</label>
                    <div class="col-md-5">
                        <input name="small_img" type="file" class="form-control input-sm" placeholder="请选择缩略图" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-md-3 control-label">价格</label>
                    <div class="col-md-5">
                        <input name="price" type="number" class="form-control input-sm" placeholder="请填写价格" required>
                    </div>
                </div>
                <div class="form-group">
                    <label for="" class="col-md-3 control-label">文章内容</label>
                    <div class="col-md-8">
                        <div id="editor"></div>
                    </div>
                </div>
                <div class="form-group">
                    <div class="col-md-8">
                        <input href="#" class="btn btn-danger btn-sm pull-right" value="添加文章" type="submit">
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

<!-- 要新增的脚本 -->
{% block script %}
<script src="./js/wangEditor/release/wangEditor.js"></script>
<script>
    $(function () {
        // 1.配置编辑器
        let E = window.wangEditor;
        let editor = new E('#editor')

        // 2.自定义上传事件
        editor.customConfig.customUploadImg = function (files, insert) {
            // files 是 input 中选中的文件列表
            // insert 是获取图片 url 后，插入到编辑器的方法
            console.log(files);
            console.log(files[0]);
            // 2.1 上传图片到服务器
            if(files.length > 0) {
                // 取出图片
                let formData  = new FormData();
                formData.append('image_url', files[0]);
                // 发起ajax请求
                $.ajax({
                    url: 'http://localhost:3000/back/source/api/add_img',
                    type: 'post',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function (data) { 
                        if(data.status === 200) { //上传成功
                            // 上传代码返回结果之后，将图片插入到编辑器中
                            // insert(imgUrl)
                            insert(data.result);
                        }
                     }
                })
            }
        }

        // 3.创建编辑器
        editor.create();


        // 4.提交数据，发起请求
        $('form').on('submit', function () {
            // alert('提交成功！');
            // 获取编辑器中的内容
            let content = editor.txt.html();
            if(content){
                // 初始化数据
                let formData = new FormData($(this).get(0));
                formData.append('content', content);
                let $form = $('form');
                $.ajax({
                    url: $form.attr('action'),
                    type: $form.attr('method'),
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(data){
                        console.log(data);
                        if(data.status === 200){
                            alert('资源文章添加成功！');
                            // 跳转到资源文章列表页面
                            window.location.href = '/back/source_list';
                        } else {
                            alert('添加资源文章失败！');
                        }
                    }
                })
            }

            return false; //阻止默认的提交事件
        })
    });
</script>
{% endblock %}