<!-- 继承base.html的基础样式 -->
{% extends "back/base.html" %}
<!-- 要新增的样式 -->
{% block style %}
{% endblock %}

<!-- 主要内容 -->
{% block body %}
<div class="container-fluid">
    <div class="body advert">
        <ol class="breadcrumb">
            <li><a href="/back/source_list">资源管理</a></li>
            <li class="active">资源管理列表</li>
        </ol>
        <div class="page-title">
            <a href="/back/source_add" class="btn btn-danger btn-sm pull-right">添加文章</a>
        </div>
        <div class="panel panel-default">
            <div class="panel-body">
                <form action="" class="form-inline">
                    <select name="" class="form-control input-sm">
                        <option value="">按课程</option>
                    </select>
                    <select name="" class="form-control input-sm">
                        <option value="">按学科</option>
                    </select>
                    <select name="" class="form-control input-sm">
                        <option value="">按热度</option>
                    </select>
                    <select name="" class="form-control input-sm">
                        <option value="">按日期</option>
                    </select>
                    <button class="btn btn-primary btn-sm">排序</button>
                </form>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <td>序号</td>
                        <th>文章标题</th>
                        <th>缩略图</th>
                        <th>收藏</th>
                        <th>价格</th>
                        <th>作者</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="tbody">
                </tbody>
            </table>
        </div>
        <!-- 分页 -->
        <ul id="pagination" class="pagination pull-right"></ul>
    </div>
</div>
{% endblock %}

<!-- 要新增的脚本 -->
{% block script %}
<script src="./js/jquery.twbsPagination.js"></script>
<script>
    $(function () {
        // 1.请求总页数
        let pageSize = 2;
        $.ajax({
            url: 'http://localhost:3000/back/source/api/count',
            type: 'get',
            dataType: 'json',
            success: function (data) {
                if (data.status === 200) {
                    console.log(data.result);
                    $('#pagination').twbsPagination({
                        totalPages: Math.ceil(data.result / pageSize),
                        visiblePages: 5,
                        first: '首页',
                        prev: '上一页',
                        next: '下一页',
                        last: '尾页',
                        onPageClick: function (event, page) {
                            // 加载数据
                            console.log('当前页码' + page)
                            loadData(page);
                        }
                    })
                } else {
                    alert('数据出现异常！');
                }
            }
        });
        // 2.加载数据
        function loadData(page) {
            // 发起请求
            $.ajax({
                // /back/source/api/list
                url: 'http://localhost:3000/back/source/api/list',
                type: 'get',
                data: {
                    'page': page,
                    'pageSize': pageSize
                },
                dataType: 'json',
                success: function (data) {
                    if (data.status === 200) {
                        console.log('page----data');
                        console.log(data.result);
                        // 注入数据
                        let tpl = ``;
                        $(data.result).each((index, source) => {
                            tpl += `
                            <tr>
                                <td>${ index+1 }</td>
                                <td>${ source.title }</td>
                                <td>
                                    <img src="/uploads/${source.small_img}" style="width: 50px; margin: 0 auto;">
                                </td>
                                <td>${ source.is_store }</td>
                                <td>${ source.price }</td>
                                <td>${ source.author }</td>
                                <td>
                                    <a data-id="${source._id}" href="javascript:;" class="btn btn-primary btn-xs s-edit">编辑</a>
                                    <a data-id="${source._id}" href="javascript:;" class="btn btn-danger btn-xs s-del">删除</a>
                                </td>
                            </tr>
                            `;
                        });
                        // 插入模板
                        $("#tbody").html(tpl);

                        // 3.点击编辑
                        $(".s-edit").on('click', function () {
                            // alert('你点击了编辑按钮！');
                            let sourceId = $(this).attr('data-id');
                            window.location.href = `/back/source_edit?sid=${sourceId}`;
                            // return false;
                        });

                        // 4.点击删除
                        $(".s-del").on('click', function () {
                            // alert('你点击了删除按钮！');
                            // 4.0 获取sourceId
                            let sourceId = $(this).attr('data-id');
                            // 4.1 发起删除请求
                            $.get('/back/source/api/remove/' + sourceId, (data) => {
                                console.log(data);
                                if (data.status === 200) {
                                    alert('删除资源文章成功！');
                                    // 4.2 页面重新加载
                                    window.location.reload();
                                } else {
                                    alert('删除资源文章失败！');
                                }
                            })
                            // return false;
                        });

                    }
                }
            })
        }
    })
</script>
{% endblock %}